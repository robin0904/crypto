<!DOCTYPE html>
<html>
<head>
<title>Crypto Analysis Hub | CryptoVerse Live</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="assets/animations.css">
<link rel="stylesheet" href="assets/gamification.css">
<link rel="stylesheet" href="assets/ai-predictor.css">
<link rel="stylesheet" href="assets/crypto-games.css">

<style>
:root {
  --primary-glow: #00ff88;
  --secondary-glow: #0099ff;
  --danger-glow: #ff0066;
  --warning-glow: #ffaa00;
  --bg-dark: #0a0a0f;
  --bg-card: #1a1a2e;
  --bg-glass: rgba(26, 26, 46, 0.8);
}

* { box-sizing: border-box; }

body {
  background: var(--bg-dark);
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(0, 255, 136, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(0, 153, 255, 0.1) 0%, transparent 50%);
  color: #fff;
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  line-height: 1.6;
}

.header {
  padding: 20px;
  text-align: center;
  background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 153, 255, 0.1));
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(0, 255, 136, 0.2);
  position: sticky;
  top: 0;
  z-index: 100;
}

.nav-menu {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.nav-item {
  padding: 8px 16px;
  background: rgba(0, 255, 136, 0.1);
  border: 1px solid rgba(0, 255, 136, 0.3);
  border-radius: 20px;
  text-decoration: none;
  color: var(--primary-glow);
  transition: all 0.3s ease;
  font-size: 14px;
}

.nav-item:hover {
  background: var(--primary-glow);
  color: #000;
  transform: translateY(-2px);
}

.page {
  display: grid;
  grid-template-columns: 300px 1fr 300px;
  gap: 25px;
  padding: 30px 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.main-card {
  background: var(--bg-glass);
  border-radius: 20px;
  border: 2px solid rgba(0, 255, 136, 0.2);
  box-shadow: 0 0 35px rgba(0, 255, 136, 0.15);
  padding: 30px;
  backdrop-filter: blur(15px);
  animation: fadeIn 0.8s ease forwards;
}

.side-panel {
  background: var(--bg-glass);
  border-radius: 18px;
  border: 1px solid rgba(0, 255, 136, 0.2);
  backdrop-filter: blur(10px);
  padding: 20px;
  height: fit-content;
  max-height: 80vh;
  overflow-y: auto;
}

.coin-header {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.coin-logo {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 3px solid var(--primary-glow);
  box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
}

.coin-info h1 {
  margin: 0;
  font-family: 'Orbitron', monospace;
  font-size: 32px;
  font-weight: 900;
  background: linear-gradient(45deg, var(--primary-glow), var(--secondary-glow));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.coin-symbol {
  font-size: 16px;
  opacity: 0.7;
  margin-top: 5px;
}

.price-section {
  text-align: center;
  margin: 30px 0;
  padding: 25px;
  background: rgba(0, 255, 136, 0.05);
  border-radius: 15px;
  border: 1px solid rgba(0, 255, 136, 0.2);
}

.current-price {
  font-size: 48px;
  font-weight: 700;
  font-family: 'Orbitron', monospace;
  margin: 10px 0;
  text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
}

.price-change {
  font-size: 20px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

#spark {
  width: 100%;
  height: 80px;
  filter: drop-shadow(0 0 12px var(--primary-glow));
  border: none;
  margin: 20px 0;
  border-radius: 10px;
  background: rgba(0, 255, 136, 0.05);
}

.indicators {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin: 25px 0;
}

.indicator-card {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  border: 1px solid rgba(0, 255, 136, 0.3);
  padding: 15px;
  text-align: center;
  transition: all 0.3s ease;
}

.indicator-card:hover {
  background: rgba(0, 255, 136, 0.1);
  transform: translateY(-3px);
}

.indicator-label {
  font-size: 12px;
  opacity: 0.7;
  margin-bottom: 8px;
}

.indicator-value {
  font-size: 18px;
  font-weight: 600;
  color: var(--primary-glow);
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin: 25px 0;
}

.info-card {
  background: rgba(255, 255, 255, 0.05);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.info-card:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: var(--primary-glow);
}

.info-label {
  font-size: 14px;
  opacity: 0.7;
  margin-bottom: 8px;
}

.info-value {
  font-size: 16px;
  font-weight: 600;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 30px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(0, 255, 136, 0.25);
  padding: 25px;
  border-radius: 15px;
  transition: all 0.3s ease;
}

.stat-card:hover {
  background: rgba(0, 255, 136, 0.08);
  transform: translateY(-5px);
}

.chart-container {
  border-radius: 16px;
  border: 2px solid rgba(0, 255, 136, 0.25);
  box-shadow: 0 0 25px rgba(0, 255, 136, 0.25);
  overflow: hidden;
  margin-top: 30px;
  background: rgba(0, 0, 0, 0.3);
}

.news-item {
  padding: 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 8px;
  margin-bottom: 10px;
}

.news-item:hover {
  background: rgba(0, 255, 136, 0.1);
  transform: translateX(5px);
}

.news-badge {
  font-size: 10px;
  background: linear-gradient(45deg, var(--danger-glow), var(--warning-glow));
  padding: 4px 8px;
  border-radius: 12px;
  margin-right: 8px;
  font-weight: 600;
}

.news-date {
  font-size: 11px;
  opacity: 0.6;
  margin-top: 5px;
}

.section-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 20px;
  color: var(--primary-glow);
  display: flex;
  align-items: center;
  gap: 10px;
}

.green { color: var(--primary-glow); }
.red { color: var(--danger-glow); }

.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(0, 255, 136, 0.3);
  border-top: 3px solid var(--primary-glow);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Responsive Design */
@media (max-width: 1200px) {
  .page {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .side-panel {
    max-height: none;
  }
}

/* Currency Switcher Styles */
.currency-btn:hover {
  background: rgba(0, 255, 136, 0.2) !important;
  transform: translateY(-2px);
}

.currency-btn.active {
  background: var(--primary-glow) !important;
  color: #000 !important;
  box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
}

@media (max-width: 768px) {
  .coin-header {
    flex-direction: column;
    text-align: center;
  }
  
  .current-price {
    font-size: 36px;
  }
  
  .indicators {
    grid-template-columns: 1fr;
  }
  
  .info-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<div class="header">
  <h1 style="font-family: 'Orbitron', monospace; margin: 0;"><i class="fas fa-chart-line"></i> Crypto Analysis Hub</h1>
  <div class="nav-menu">
    <a href="index.html" class="nav-item"><i class="fas fa-home"></i> Home</a>
    <a href="news.html" class="nav-item"><i class="fas fa-newspaper"></i> News</a>
    <a href="portfolio.html" class="nav-item"><i class="fas fa-chart-pie"></i> Portfolio</a>
  </div>
</div>

<div class="page">

  <!-- Left Panel: Market Insights -->
  <div class="side-panel">
    <div class="section-title">
      <i class="fas fa-chart-bar"></i> Market Insights
    </div>
    <div id="marketInsights">
      <div class="loading"><div class="spinner"></div></div>
    </div>
    
    <div class="section-title" style="margin-top: 30px;">
      <i class="fas fa-fire"></i> Related News
    </div>
    <div id="relatedNews">
      <div class="loading"><div class="spinner"></div></div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-card">
    
    <!-- Currency Switcher -->
    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
      <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 25px; padding: 5px; display: flex; gap: 5px;">
        <button class="currency-btn active" data-currency="inr" style="padding: 8px 15px; border: none; border-radius: 20px; background: var(--primary-glow); color: #000; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">₹ INR</button>
        <button class="currency-btn" data-currency="usd" style="padding: 8px 15px; border: none; border-radius: 20px; background: transparent; color: var(--primary-glow); font-weight: 600; cursor: pointer; transition: all 0.3s ease;">$ USD</button>
        <button class="currency-btn" data-currency="eur" style="padding: 8px 15px; border: none; border-radius: 20px; background: transparent; color: var(--primary-glow); font-weight: 600; cursor: pointer; transition: all 0.3s ease;">€ EUR</button>
        <button class="currency-btn" data-currency="btc" style="padding: 8px 15px; border: none; border-radius: 20px; background: transparent; color: var(--primary-glow); font-weight: 600; cursor: pointer; transition: all 0.3s ease;">₿ BTC</button>
      </div>
    </div>

    <div class="coin-header">
      <img id="coinLogo" class="coin-logo" alt="Coin Logo"/>
      <div class="coin-info">
        <h1 id="coinName">Loading...</h1>
        <div class="coin-symbol" id="coinSymbol">...</div>
      </div>
    </div>

    <div class="price-section">
      <div class="current-price" id="currentPrice">₹0.00</div>
      <div class="price-change" id="priceChange">
        <i class="fas fa-arrow-up"></i> 0.00%
      </div>
    </div>

    <canvas id="spark"></canvas>

    <div class="indicators">
      <div class="indicator-card">
        <div class="indicator-label">Fear & Greed</div>
        <div class="indicator-value" id="fearIndex">Loading...</div>
      </div>
      <div class="indicator-card">
        <div class="indicator-label">RSI (14)</div>
        <div class="indicator-value" id="rsiValue">Calculating...</div>
      </div>
      <div class="indicator-card">
        <div class="indicator-label">Market Sentiment</div>
        <div class="indicator-value" id="sentiment">Analyzing...</div>
      </div>
    </div>

    <div class="info-grid">
      <div class="info-card">
        <div class="info-label">24h High</div>
        <div class="info-value" id="high24h">₹0.00</div>
      </div>
      <div class="info-card">
        <div class="info-label">24h Low</div>
        <div class="info-value" id="low24h">₹0.00</div>
      </div>
      <div class="info-card">
        <div class="info-label">24h Volume</div>
        <div class="info-value" id="volume24h">₹0.00</div>
      </div>
      <div class="info-card">
        <div class="info-label">Market Cap</div>
        <div class="info-value" id="marketCap">₹0.00</div>
      </div>
      <div class="info-card">
        <div class="info-label">Circulating Supply</div>
        <div class="info-value" id="circulatingSupply">0</div>
      </div>
      <div class="info-card">
        <div class="info-label">Market Rank</div>
        <div class="info-value" id="marketRank">#0</div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h4><i class="fas fa-trophy"></i> All-Time High</h4>
        <div style="font-size: 20px; font-weight: 600; margin: 10px 0;" id="athPrice">₹0.00</div>
        <div style="font-size: 14px; opacity: 0.7;" id="athDate">-</div>
      </div>
      
      <div class="stat-card">
        <h4><i class="fas fa-chart-area"></i> Price Prediction</h4>
        <div id="pricePrediction">
          <div style="margin: 10px 0;">
            <span style="opacity: 0.7;">Next 7 days:</span>
            <span id="prediction7d" style="font-weight: 600;">Analyzing...</span>
          </div>
        </div>
      </div>
      
      <div class="stat-card">
        <h4><i class="fas fa-shield-alt"></i> Support & Resistance</h4>
        <div style="margin: 10px 0;">
          <div>Support: <span id="supportLevel" style="color: var(--primary-glow); font-weight: 600;">₹0.00</span></div>
          <div>Resistance: <span id="resistanceLevel" style="color: var(--danger-glow); font-weight: 600;">₹0.00</span></div>
        </div>
      </div>
      
      <div class="stat-card">
        <h4><i class="fas fa-thumbs-up"></i> Trading Recommendation</h4>
        <div id="tradingRecommendation" style="font-size: 18px; font-weight: 600; margin: 10px 0;">
          Analyzing market conditions...
        </div>
      </div>
    </div>

    <div class="chart-container">
      <div id="tradingViewChart" style="height: 500px;">
        <div class="loading" style="height: 500px;"><div class="spinner"></div></div>
      </div>
    </div>

  </div>

  <!-- Right Panel: Trading Tools -->
  <div class="side-panel">
    <div class="section-title">
      <i class="fas fa-calculator"></i> Quick Calculator
    </div>
    <div style="margin-bottom: 30px;">
      <input type="number" id="calcAmount" placeholder="Amount" style="width: 100%; padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.1); border: 1px solid rgba(0,255,136,0.3); border-radius: 5px; color: #fff;">
      <div style="margin: 10px 0; padding: 10px; background: rgba(0,255,136,0.1); border-radius: 5px;">
        <div>Value: <span id="calcValue">₹0.00</span></div>
      </div>
    </div>
    
    <div class="section-title">
      <i class="fas fa-users"></i> Social Sentiment
    </div>
    <div id="socialSentiment">
      <div style="margin: 10px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
          <span>Reddit Mentions</span>
          <span style="color: var(--primary-glow); font-weight: 600;">High</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
          <span>Twitter Buzz</span>
          <span style="color: var(--warning-glow); font-weight: 600;">Medium</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span>Overall Sentiment</span>
          <span style="color: var(--primary-glow); font-weight: 600;">Bullish</span>
        </div>
      </div>
    </div>
  </div>

</div>


<script>
class CoinAnalyzer {
  constructor() {
    this.coinId = new URLSearchParams(location.search).get("id");
    this.coinData = null;
    this.priceHistory = [];
    this.currentCurrency = 'inr'; // Default to INR
    this.currencySymbols = {
      'inr': '₹',
      'usd': '$',
      'eur': '€',
      'btc': '₿'
    };
    this.init();
  }

  async init() {
    if (!this.coinId) {
      alert("No coin specified!");
      window.location.href = "index.html";
      return;
    }

    this.setupCurrencySwitcher();
    await this.loadCoinData();
    await this.loadPriceHistory();
    await this.loadFearGreed();
    this.renderCoinInfo();
    this.renderChart();
    this.renderMarketInsights();
    this.renderRelatedNews();
    this.setupCalculator();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
      const oldPrice = this.coinData?.current_price || 0;
      this.loadCoinData().then(() => {
        this.renderCoinInfo();
        
        // Trigger animations on price change
        if (window.animationEngine && this.coinData?.current_price) {
          animationEngine.onPriceChange(this.coinData.current_price, oldPrice);
        }
      });
    }, 30000);
  }

  setupCurrencySwitcher() {
    const currencyButtons = document.querySelectorAll('.currency-btn');
    currencyButtons.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        // Remove active class from all buttons
        currencyButtons.forEach(b => b.classList.remove('active'));
        
        // Add active class to clicked button
        e.target.classList.add('active');
        
        // Update current currency
        this.currentCurrency = e.target.dataset.currency;
        
        // Reload data with new currency
        await this.loadCoinData();
        await this.loadPriceHistory();
        this.renderCoinInfo();
        this.renderChart();
      });
    });
  }

  async loadCoinData() {
    try {
      const response = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=${this.currentCurrency}&ids=${this.coinId}&include_24hr_change=true`);
      const data = await response.json();
      this.coinData = data[0];
    } catch (error) {
      console.error('Error loading coin data:', error);
    }
  }

  async loadPriceHistory() {
    try {
      const response = await fetch(`https://api.coingecko.com/api/v3/coins/${this.coinId}/market_chart?vs_currency=${this.currentCurrency}&days=30`);
      const data = await response.json();
      this.priceHistory = data.prices.map(p => p[1]);
    } catch (error) {
      console.error('Error loading price history:', error);
    }
  }

  formatPrice(price) {
    if (!price) return '0.00';
    
    const symbol = this.currencySymbols[this.currentCurrency];
    
    if (this.currentCurrency === 'btc') {
      return `${symbol}${price.toFixed(8)}`;
    } else if (price >= 1000000) {
      return `${symbol}${(price / 1000000).toFixed(2)}M`;
    } else if (price >= 1000) {
      return `${symbol}${price.toLocaleString()}`;
    } else {
      return `${symbol}${price.toFixed(2)}`;
    }
  }

  async loadFearGreed() {
    try {
      const response = await fetch('https://api.alternative.me/fng/');
      const data = await response.json();
      const fearValue = data.data[0].value;
      
      document.getElementById('fearIndex').textContent = fearValue;
      
      // Color based on fear level
      const fearElement = document.getElementById('fearIndex');
      if (fearValue < 25) {
        fearElement.style.color = '#ff0066';
        fearElement.parentElement.style.borderColor = '#ff0066';
      } else if (fearValue < 50) {
        fearElement.style.color = '#ffaa00';
        fearElement.parentElement.style.borderColor = '#ffaa00';
      } else if (fearValue < 75) {
        fearElement.style.color = '#00ff88';
        fearElement.parentElement.style.borderColor = '#00ff88';
      } else {
        fearElement.style.color = '#0099ff';
        fearElement.parentElement.style.borderColor = '#0099ff';
      }
    } catch (error) {
      console.error('Error loading fear & greed:', error);
    }
  }

  calculateRSI(prices, period = 14) {
    if (prices.length < period + 1) return 50;
    
    let gains = 0;
    let losses = 0;
    
    for (let i = 1; i <= period; i++) {
      const change = prices[i] - prices[i - 1];
      if (change > 0) gains += change;
      else losses -= change;
    }
    
    const avgGain = gains / period;
    const avgLoss = losses / period;
    const rs = avgGain / avgLoss;
    const rsi = 100 - (100 / (1 + rs));
    
    return rsi;
  }

  renderCoinInfo() {
    if (!this.coinData) return;

    const c = this.coinData;
    
    // Basic info
    document.getElementById('coinName').textContent = c.name;
    document.getElementById('coinSymbol').textContent = c.symbol.toUpperCase();
    document.getElementById('coinLogo').src = c.image;
    
    // Price info
    document.getElementById('currentPrice').textContent = this.formatPrice(c.current_price);
    
    const changeElement = document.getElementById('priceChange');
    const change = c.price_change_percentage_24h;
    const changeClass = change >= 0 ? 'green' : 'red';
    const changeIcon = change >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
    
    changeElement.className = `price-change ${changeClass}`;
    changeElement.innerHTML = `
      <i class="${changeIcon}"></i>
      ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
    `;
    
    // Market data
    document.getElementById('high24h').textContent = this.formatPrice(c.high_24h);
    document.getElementById('low24h').textContent = this.formatPrice(c.low_24h);
    
    // Format volume and market cap based on currency
    const symbol = this.currencySymbols[this.currentCurrency];
    if (this.currentCurrency === 'btc') {
      document.getElementById('volume24h').textContent = `${symbol}${(c.total_volume).toFixed(2)}`;
      document.getElementById('marketCap').textContent = `${symbol}${(c.market_cap).toFixed(2)}`;
    } else {
      document.getElementById('volume24h').textContent = `${symbol}${(c.total_volume / 1e9).toFixed(2)}B`;
      document.getElementById('marketCap').textContent = `${symbol}${(c.market_cap / 1e9).toFixed(2)}B`;
    }
    
    document.getElementById('circulatingSupply').textContent = c.circulating_supply?.toLocaleString() || 'N/A';
    document.getElementById('marketRank').textContent = `#${c.market_cap_rank || 'N/A'}`;
    
    // ATH info
    document.getElementById('athPrice').textContent = this.formatPrice(c.ath);
    document.getElementById('athDate').textContent = c.ath_date ? 
      new Date(c.ath_date).toLocaleDateString() : 'N/A';
    
    // Technical analysis
    if (this.priceHistory.length > 0) {
      const rsi = this.calculateRSI(this.priceHistory);
      document.getElementById('rsiValue').textContent = rsi.toFixed(1);
      
      // RSI color coding
      const rsiElement = document.getElementById('rsiValue');
      if (rsi > 70) {
        rsiElement.style.color = '#ff0066';
        rsiElement.parentElement.style.borderColor = '#ff0066';
      } else if (rsi < 30) {
        rsiElement.style.color = '#00ff88';
        rsiElement.parentElement.style.borderColor = '#00ff88';
      } else {
        rsiElement.style.color = '#ffaa00';
        rsiElement.parentElement.style.borderColor = '#ffaa00';
      }
      
      // Support and resistance
      const recent = this.priceHistory.slice(-14);
      const support = Math.min(...recent) * 0.98;
      const resistance = Math.max(...recent) * 1.02;
      
      document.getElementById('supportLevel').textContent = this.formatPrice(support);
      document.getElementById('resistanceLevel').textContent = this.formatPrice(resistance);
      
      // Trading recommendation
      this.generateTradingRecommendation(rsi, change);
    }
    
    // Market sentiment
    const sentiment = change > 5 ? 'Very Bullish' : 
                     change > 0 ? 'Bullish' : 
                     change > -5 ? 'Bearish' : 'Very Bearish';
    document.getElementById('sentiment').textContent = sentiment;
    
    // Price prediction (simple trend analysis)
    const trend = this.priceHistory.length > 7 ? 
      this.priceHistory.slice(-7).reduce((sum, price, i, arr) => 
        i > 0 ? sum + (price - arr[i-1]) : sum, 0) : 0;
    
    const prediction = trend > 0 ? 'Upward Trend' : 
                      trend < 0 ? 'Downward Trend' : 'Sideways';
    document.getElementById('prediction7d').textContent = prediction;
  }

  generateTradingRecommendation(rsi, priceChange) {
    let recommendation = '';
    let color = '';
    
    if (rsi > 70 && priceChange > 0) {
      recommendation = 'SELL - Overbought';
      color = '#ff0066';
    } else if (rsi < 30 && priceChange < 0) {
      recommendation = 'BUY - Oversold';
      color = '#00ff88';
    } else if (priceChange > 5) {
      recommendation = 'HOLD - Strong Uptrend';
      color = '#0099ff';
    } else if (priceChange < -5) {
      recommendation = 'CAUTION - Downtrend';
      color = '#ffaa00';
    } else {
      recommendation = 'HOLD - Neutral';
      color = '#ffffff';
    }
    
    const element = document.getElementById('tradingRecommendation');
    element.textContent = recommendation;
    element.style.color = color;
  }

  renderChart() {
    if (this.priceHistory.length === 0) return;
    
    const canvas = document.getElementById('spark');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw price chart
    const prices = this.priceHistory.slice(-50);
    const maxPrice = Math.max(...prices);
    const minPrice = Math.min(...prices);
    const priceRange = maxPrice - minPrice;
    
    ctx.beginPath();
    ctx.strokeStyle = '#00ff88';
    ctx.lineWidth = 2;
    
    prices.forEach((price, i) => {
      const x = (i / (prices.length - 1)) * canvas.width;
      const y = canvas.height - ((price - minPrice) / priceRange) * canvas.height;
      
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    
    ctx.stroke();
    
    // Add gradient fill
    ctx.lineTo(canvas.width, canvas.height);
    ctx.lineTo(0, canvas.height);
    ctx.closePath();
    
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, 'rgba(0, 255, 136, 0.3)');
    gradient.addColorStop(1, 'rgba(0, 255, 136, 0.05)');
    
    ctx.fillStyle = gradient;
    ctx.fill();
    
    // Load TradingView chart
    document.getElementById('tradingViewChart').innerHTML = `
      <iframe 
        width="100%" 
        height="500" 
        frameborder="0" 
        src="https://s.tradingview.com/widgetembed/?symbol=${this.coinData?.symbol?.toUpperCase() || 'BTC'}USD&interval=60&theme=dark&style=1&locale=en&toolbar_bg=%23f1f3f6&enable_publishing=false&hide_top_toolbar=true&hide_legend=true&save_image=false&container_id=tradingview_chart">
      </iframe>
    `;
  }

  renderMarketInsights() {
    const insights = [
      {
        title: "Market Cap Rank",
        value: `#${this.coinData?.market_cap_rank || 'N/A'}`,
        icon: "fas fa-trophy"
      },
      {
        title: "24h Volume Rank",
        value: "Top 50",
        icon: "fas fa-chart-bar"
      },
      {
        title: "Volatility",
        value: "Medium",
        icon: "fas fa-wave-square"
      },
      {
        title: "Liquidity",
        value: "High",
        icon: "fas fa-tint"
      }
    ];
    
    const html = insights.map(insight => `
      <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(0,255,136,0.2);">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
          <i class="${insight.icon}" style="color: var(--primary-glow);"></i>
          <span style="font-size: 14px; opacity: 0.8;">${insight.title}</span>
        </div>
        <div style="font-size: 16px; font-weight: 600; color: var(--primary-glow);">
          ${insight.value}
        </div>
      </div>
    `).join('');
    
    document.getElementById('marketInsights').innerHTML = html;
  }

  renderRelatedNews() {
    const newsItems = [
      {
        title: `${this.coinData?.name || 'Crypto'} Shows Strong Technical Signals`,
        time: "2 hours ago",
        source: "CryptoNews"
      },
      {
        title: "Market Analysis: Bullish Momentum Building",
        time: "4 hours ago",
        source: "TradingView"
      },
      {
        title: "Institutional Interest Continues to Grow",
        time: "6 hours ago",
        source: "CoinDesk"
      },
      {
        title: "Technical Analysis: Key Levels to Watch",
        time: "8 hours ago",
        source: "CryptoDaily"
      }
    ];
    
    const html = newsItems.map(news => `
      <div class="news-item">
        <div style="font-size: 14px; font-weight: 500; margin-bottom: 5px;">
          ${news.title}
        </div>
        <div class="news-date">
          ${news.source} • ${news.time}
        </div>
      </div>
    `).join('');
    
    document.getElementById('relatedNews').innerHTML = html;
  }

  setupCalculator() {
    const calcInput = document.getElementById('calcAmount');
    const calcValue = document.getElementById('calcValue');
    
    calcInput.addEventListener('input', () => {
      const amount = parseFloat(calcInput.value) || 0;
      const price = this.coinData?.current_price || 0;
      const value = amount * price;
      calcValue.textContent = this.formatPrice(value);
    });
  }
}

// Initialize the coin analyzer
document.addEventListener('DOMContentLoaded', () => {
  new CoinAnalyzer();
  
  // Load 3D effects and gamification
  const script1 = document.createElement('script');
  script1.src = 'assets/3d-effects.js';
  document.head.appendChild(script1);

  const script2 = document.createElement('script');
  script2.src = 'assets/gamification.js';
  document.head.appendChild(script2);
  
  const script3 = document.createElement('script');
  script3.src = 'assets/ai-predictor.js';
  document.head.appendChild(script3);
  
  const script4 = document.createElement('script');
  script4.src = 'assets/crypto-games.js';
  document.head.appendChild(script4);
  
  const script5 = document.createElement('script');
  script5.src = 'assets/professional-animations.js';
  document.head.appendChild(script5);
  
  // Track coin visit for gamification
  setTimeout(() => {
    if (window.gameSystem) {
      gameSystem.trackEvent('coin_visit');
    }
  }, 1000);
});
</script>

</body>
</html>
